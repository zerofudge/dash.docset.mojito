<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>node_modules&#x2F;mojito&#x2F;lib&#x2F;app&#x2F;addons&#x2F;rs&#x2F;config.js - Mojito API</title>
    <link rel="stylesheet" href="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;3.8.0pr2&#x2F;build&#x2F;cssgrids&#x2F;cssgrids-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="..&#x2F;assets/favicon.png">
    <script src="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;combo?3.8.0pr2&#x2F;build&#x2F;yui&#x2F;yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="http:&#x2F;&#x2F;developer.yahoo.com&#x2F;cocktails&#x2F;mojito&#x2F;api&#x2F;assets&#x2F;img&#x2F;mojito-logo-white-bkg.png" title="Mojito API"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.7.5</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="..&#x2F;classes/ActionContext.html">ActionContext</a></li>
            
                <li><a href="..&#x2F;classes/Analytics.common.html">Analytics.common</a></li>
            
                <li><a href="..&#x2F;classes/Assets.common.html">Assets.common</a></li>
            
                <li><a href="..&#x2F;classes/Composite.common.html">Composite.common</a></li>
            
                <li><a href="..&#x2F;classes/Config.common.html">Config.common</a></li>
            
                <li><a href="..&#x2F;classes/Cookie.client.html">Cookie.client</a></li>
            
                <li><a href="..&#x2F;classes/Cookie.server.html">Cookie.server</a></li>
            
                <li><a href="..&#x2F;classes/Data.common.data.html">Data.common.data</a></li>
            
                <li><a href="..&#x2F;classes/Data.common.pageData.html">Data.common.pageData</a></li>
            
                <li><a href="..&#x2F;classes/Deploy.server.html">Deploy.server</a></li>
            
                <li><a href="..&#x2F;classes/Helpers.common.html">Helpers.common</a></li>
            
                <li><a href="..&#x2F;classes/Http.server.html">Http.server</a></li>
            
                <li><a href="..&#x2F;classes/Intl.common.html">Intl.common</a></li>
            
                <li><a href="..&#x2F;classes/Meta.common.html">Meta.common</a></li>
            
                <li><a href="..&#x2F;classes/Model.Vanilla.html">Model.Vanilla</a></li>
            
                <li><a href="..&#x2F;classes/Models.common.html">Models.common</a></li>
            
                <li><a href="..&#x2F;classes/MojitoDispatcher.html">MojitoDispatcher</a></li>
            
                <li><a href="..&#x2F;classes/MojitoPerf.html">MojitoPerf</a></li>
            
                <li><a href="..&#x2F;classes/MojitoRouter.html">MojitoRouter</a></li>
            
                <li><a href="..&#x2F;classes/MojitProxy.html">MojitProxy</a></li>
            
                <li><a href="..&#x2F;classes/OutputBuffer.html">OutputBuffer</a></li>
            
                <li><a href="..&#x2F;classes/OutputHandler.html">OutputHandler</a></li>
            
                <li><a href="..&#x2F;classes/Params.common.html">Params.common</a></li>
            
                <li><a href="..&#x2F;classes/Partial.common.html">Partial.common</a></li>
            
                <li><a href="..&#x2F;classes/ResourceStore.server.html">ResourceStore.server</a></li>
            
                <li><a href="..&#x2F;classes/RSAddonConfig.html">RSAddonConfig</a></li>
            
                <li><a href="..&#x2F;classes/RSAddonDispatchHelper.html">RSAddonDispatchHelper</a></li>
            
                <li><a href="..&#x2F;classes/RSAddonMime.html">RSAddonMime</a></li>
            
                <li><a href="..&#x2F;classes/RSAddonSelector.html">RSAddonSelector</a></li>
            
                <li><a href="..&#x2F;classes/RSAddonUrl.html">RSAddonUrl</a></li>
            
                <li><a href="..&#x2F;classes/RSAddonYUI.html">RSAddonYUI</a></li>
            
                <li><a href="..&#x2F;classes/Url.common.html">Url.common</a></li>
            
                <li><a href="..&#x2F;classes/Y.mojito.Client.html">Y.mojito.Client</a></li>
            
                <li><a href="..&#x2F;classes/Y.mojito.lib.REST.html">Y.mojito.lib.REST</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="..&#x2F;modules/ActionContext.html">ActionContext</a></li>
            
                <li><a href="..&#x2F;modules/ActionContextAddon.html">ActionContextAddon</a></li>
            
                <li><a href="..&#x2F;modules/app.html">app</a></li>
            
                <li><a href="..&#x2F;modules/CommonLibs.html">CommonLibs</a></li>
            
                <li><a href="..&#x2F;modules/Data.common.html">Data.common</a></li>
            
                <li><a href="..&#x2F;modules/model-vanilla.html">model-vanilla</a></li>
            
                <li><a href="..&#x2F;modules/mojito-perf.html">mojito-perf</a></li>
            
                <li><a href="..&#x2F;modules/MojitoClient.html">MojitoClient</a></li>
            
                <li><a href="..&#x2F;modules/MojitoHooks.html">MojitoHooks</a></li>
            
                <li><a href="..&#x2F;modules/OutputBuffer.html">OutputBuffer</a></li>
            
                <li><a href="..&#x2F;modules/ResourceStore.html">ResourceStore</a></li>
            
                <li><a href="..&#x2F;modules/ResourceStoreAddon.html">ResourceStoreAddon</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: node_modules&#x2F;mojito&#x2F;lib&#x2F;app&#x2F;addons&#x2F;rs&#x2F;config.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x2F;*
 * Copyright (c) 2012, Yahoo! Inc.  All rights reserved.
 * Copyrights licensed under the New BSD License.
 * See the accompanying LICENSE file for terms.
 *&#x2F;

&#x2F;*jslint anon:true, sloppy:true, nomen:true, stupid:true, node:true *&#x2F;
&#x2F;*global YUI*&#x2F;


&#x2F;**
 * The &lt;strong&gt;Resource Store&lt;&#x2F;strong&gt; is a Y.Base -- a host for Y.Plugins.
 * Each Addon provides additional functions through a namespace that is
 * attached directly to the resource store.
 * @module ResourceStoreAddon
 *&#x2F;


&#x2F;**
 * @class RSAddonConfig
 * @extension ResourceStore.server
 *&#x2F;
YUI.add(&#x27;addon-rs-config&#x27;, function(Y, NAME) {

    &#x27;use strict&#x27;;

    var libfs = require(&#x27;fs&#x27;),
        libpath = require(&#x27;path&#x27;),
        existsSync = libfs.existsSync || libpath.existsSync,
        libycb = require(&#x27;ycb&#x27;),
        libyaml = require(&#x27;js-yaml&#x27;);

    function RSAddonConfig() {
        RSAddonConfig.superclass.constructor.apply(this, arguments);
    }
    RSAddonConfig.NS = &#x27;config&#x27;;

    Y.extend(RSAddonConfig, Y.Plugin.Base, {

        &#x2F;**
         * This methods is part of Y.Plugin.Base.  See documentation for that for details.
         * @method initializer
         * @param {object} config Configuration object as per Y.Plugin.Base
         * @return {nothing}
         *&#x2F;
        initializer: function(config) {
            this.appRoot = config.appRoot;
            this.mojitoRoot = config.mojitoRoot;
            this.afterHostMethod(&#x27;findResourceVersionByConvention&#x27;, this.findResourceVersionByConvention, this);
            this.beforeHostMethod(&#x27;parseResourceVersion&#x27;, this.parseResourceVersion, this);

            this._jsonCache = {};   &#x2F;&#x2F; fullPath: contents as JSON object
            this._simpleCache = {}; &#x2F;&#x2F; fullPath: contents as JSON object
            this._ycbCache = {};    &#x2F;&#x2F; fullPath: context: YCB config object
            this._ycbDims = this._readYcbDimensions();
            this._ycbAppConfig = this._readYcbAppConfig();
        },


        &#x2F;**
         * Returns the YCB dimensions for the application.
         * @method getDimensions
         * @return {object} the YCB dimensions structure for the app
         *&#x2F;
        getDimensions: function() {
            return Y.mojito.util.copy(this._ycbDims);
        },


        &#x2F;**
         * Returns the YCB library object for the application config.
         * @method getAppConfigYCB
         * @return {YCB} YCB library object for the application config
         *&#x2F;
        getAppConfigYCB: function() {
            return this._ycbAppConfig;
        },


        &#x2F;**
         * Reads a JSON file.  In mojito, this should generally only be used for
         * package.json files, and all other mojito config files should instead
         * be read using readConfigSimple() or readConfigYCB().
         * @method readConfigJSON
         * @param {string} fullPath path to JSON file
         * @return {user-defined} contents of file as an object
         *&#x2F;
        readConfigJSON: function(fullPath) {
            var json,
                contents;
            if (!existsSync(fullPath)) {
                return {};
            }
            json = this._jsonCache[fullPath];
            if (!json) {
                try {
                    contents = libfs.readFileSync(fullPath, &#x27;utf-8&#x27;);
                    json = JSON.parse(contents);
                } catch (e) {
                    throw new Error(&#x27;Error parsing JSON file: &#x27; + fullPath);
                }
                this._jsonCache[fullPath] = json;
            }
            return Y.mojito.util.copy(json);
        },


        &#x2F;**
         * Reads and parses a JSON or YAML structured file.
         * @method readConfigSimple
         * @param {string} fullPath path to JSON or YAML file
         * @return {user-defined} contents of file as an object
         *&#x2F;
        readConfigSimple: function(fullPath) {
            var extensions = [&#x27;.yml&#x27;, &#x27;.yaml&#x27;, &#x27;.json&#x27;],
                basename,   &#x2F;&#x2F; everything except the extension
                i,
                json = false,
                raw,
                obj;

            obj = this._simpleCache[fullPath];
            if (!obj) {
                basename = fullPath;
                if (libpath.extname(fullPath)) {
                    basename = fullPath.slice(0, libpath.extname(fullPath).length * -1);
                }
                for (i = extensions.length - 1; i &gt;= 0; i -= 1) {
                    try {
                        fullPath = basename + extensions[i];
                        raw = libfs.readFileSync(fullPath, &#x27;utf8&#x27;);
                        try {
                            if (i === 2) { &#x2F;&#x2F; json
                                obj = JSON.parse(raw);
                                json = true;
                            } else { &#x2F;&#x2F; yaml or yml
                                obj = libyaml.load(raw);
                                if (json) {
                                    Y.log(basename + extensions[2] + &#x27; exists but &#x27; + extensions[i] + &#x27; file will be used instead&#x27;, &#x27;warn&#x27;, NAME);
                                }
                            }
                            &#x2F;&#x2F; TODO: what happen when one of them exists?
                            &#x2F;&#x2F;       and what then more than one exists?
                        } catch (parseErr) {
                            throw new Error(parseErr);
                        }
                    } catch (err) {
                        if (err.errno !== 34) { &#x2F;&#x2F; if the error was not &quot;no such file or directory&quot; report it
                            throw new Error(&quot;Error parsing file: &quot; + fullPath + &quot;\n&quot; + err);
                        }
                    }
                }
                if (!obj) {
                    obj = {};
                }
                this._simpleCache[fullPath] = obj;
            }
            return Y.mojito.util.copy(obj);
        },


        &#x2F;**
         * Reads a configuration file that is in YCB format.
         * @method readConfigYCB
         * @param {object} ctx runtime context
         * @param {string} fullPath path to the YCB file
         * @return {object} the contextualized configuration
         *&#x2F;
        &#x2F;&#x2F; TODO:  async interface
        readConfigYCB: function(fullPath, ctx) {
            var store = this.get(&#x27;host&#x27;),
                cacheKey,
                json,
                ycb;

            ctx = store.blendStaticContext(ctx);

            if (!this._ycbCache[fullPath]) {
                this._ycbCache[fullPath] = {};
            }

            cacheKey = JSON.stringify(ctx);
            ycb = this._ycbCache[fullPath][cacheKey];
            if (!ycb) {
                json = this.readConfigSimple(fullPath);
                json = this._ycbDims.concat(json);
                ycb = libycb.read(json, ctx);
                this._ycbCache[fullPath][cacheKey] = ycb;
            }
            return Y.mojito.util.copy(ycb);
        },


        &#x2F;**
         * Creates a YCB configuration bundle using contents from multiple files.
         * The appropriate dimensions.json file will be mixed in, and doesn&#x27;t need
         * to be part of the list of files. This method is tolerant to errors, and
         * will fallback to &#x60;{}&#x60; if a file does not exists or fails to load.
         * @method createMultipartYCB
         * @param {array} paths list of files to load
         * @return {YCB} return a YCB library object
         *&#x2F;
        createMultipartYCB: function(paths) {
            var p,
                path,
                config,
                s,
                section,
                settings = {},
                bundle = [];
            bundle.push(this.getDimensions()[0]);
            for (p = 0; p &lt; paths.length; p += 1) {
                path = paths[p];
                config = this.readConfigSimple(path);
                if (!Y.Lang.isArray(config)) {
                    Y.log(&#x27;not a YCB file: &#x27; + path, &#x27;error&#x27;, NAME);
                    return;
                }
                for (s = 0; s &lt; config.length; s += 1) {
                    section = config[s];
                    if (!Y.Lang.isArray(section.settings)) {
                        Y.log(&#x27;missing &quot;settings&quot; in YCB file: &#x27; + path, &#x27;error&#x27;, NAME);
                        return;
                    }
                    if (settings[section.settings]) {
                        Y.log(&#x27;settings &quot;&#x27; + section.settings + &#x27;&quot; exists in both \n&#x27; + path +
                                &#x27; and\n&#x27; + settings[section.settings], &#x27;error&#x27;, NAME);
                        return;
                    }
                    settings[section.settings] = path;
                    bundle.push(section);
                }
            }
            return new libycb.Ycb(bundle);
        },


        &#x2F;**
         * Using AOP, this is called after the ResourceStore&#x27;s version.
         * @method findResourceVersionByConvention
         * @param {object} source metadata about where the resource is located
         * @param {string} mojitType name of mojit to which the resource likely belongs
         * @return {object||null} for config file resources, returns metadata signifying that
         *&#x2F;
        findResourceVersionByConvention: function(source, mojitType) {
            var fs = source.fs,
                use = false;

            &#x2F;&#x2F; we only care about files
            if (!fs.isFile) {
                return;
            }
            &#x2F;&#x2F; we don&#x27;t care about files in subdirectories
            if (&#x27;.&#x27; !== fs.subDir) {
                return;
            }
            &#x2F;&#x2F; we only care about json or yaml files
            if (&#x27;.json&#x27; !== fs.ext &amp;&amp; &#x27;.yaml&#x27; !== fs.ext &amp;&amp; &#x27;.yml&#x27; !== fs.ext) {
                return;
            }
            &#x2F;&#x2F; use package.json for the app and the mojit
            if (&#x27;package&#x27; === fs.basename &amp;&amp; &#x27;bundle&#x27; !== fs.rootType) {
                use = true;
            }
            &#x2F;&#x2F; use all configs in the application
            if (&#x27;app&#x27; === fs.rootType) {
                use = true;
            }
            &#x2F;&#x2F; use configs from non-shared mojit resources
            if (mojitType &amp;&amp; &#x27;shared&#x27; !== mojitType) {
                use = true;
            }
            if (!use) {
                return;
            }

            return new Y.Do.AlterReturn(null, {
                type: &#x27;config&#x27;
            });
        },


        &#x2F;**
         * Using AOP, this is called before the ResourceStore&#x27;s version.
         * @method parseResourceVersion
         * @param {object} source metadata about where the resource is located
         * @param {string} type type of the resource
         * @param {string} subtype subtype of the resource
         * @param {string} mojitType name of mojit to which the resource likely belongs
         * @return {object||null} for config file resources, returns the resource metadata
         *&#x2F;
        parseResourceVersion: function(source, type, subtype, mojitType) {
            var baseParts,
                res;

            if (&#x27;config&#x27; !== type) {
                return;
            }

            baseParts = source.fs.basename.split(&#x27;.&#x27;);
            if (baseParts.length !== 1) {
                Y.log(&#x27;invalid config filename. skipping &#x27; + source.fs.fullPath, &#x27;warn&#x27;, NAME);
                return;
            }
            res = {
                source: source,
                type: &#x27;config&#x27;,
                affinity: &#x27;common&#x27;,
                selector: &#x27;*&#x27;
            };
            if (&#x27;app&#x27; !== source.fs.rootType) {
                res.mojit = mojitType;
            }
            res.name = libpath.join(source.fs.subDir, baseParts.join(&#x27;.&#x27;));
            res.id = [res.type, res.subtype, res.name].join(&#x27;-&#x27;);
            return new Y.Do.Halt(null, res);
        },


        &#x2F;**
         * Read the application&#x27;s dimensions.json file for YCB processing. If not
         * available, fall back to the framework&#x27;s default dimensions.json.
         * @private
         * @method _readYcbDimensions
         * @return {array} contents of the dimensions.json file
         *&#x2F;
        _readYcbDimensions: function() {
            var path = libpath.join(this.appRoot, &#x27;dimensions.json&#x27;);
            if (!existsSync(path)) {
                path = libpath.join(this.mojitoRoot, &#x27;dimensions.json&#x27;);
            }
            return this.readConfigSimple(path);
        },

        &#x2F;**
         * Initializes the special multi-file YCB library for all the application
         * files. By default, we try to load &#x60;application.json&#x60;, then mix any other
         * relative config file specified in the master section under the
         * &#x60;applicationConfigFiles&#x60; array, which is optional.
         * @private
         * @method _readYcbAppConfig
         * @return {object} libycb object
         *&#x2F;
        _readYcbAppConfig: function() {
            var ycb,
                i,
                rootAppJSON = libpath.join(this.appRoot, &#x27;application.json&#x27;),
                paths = [],
                relativePaths;

            &#x2F;&#x2F; since application.json is optional, we should be careful
            &#x2F;&#x2F; in any case there is a low-level cache mechanism going on here.
            if (Y.Lang.isArray(this.readConfigSimple(rootAppJSON))) {
                &#x2F;&#x2F; ensuring the context runtime:server to read applicationConfigFiles,
                &#x2F;&#x2F; it does not matter if runtime is not a dimension, it works just fine
                &#x2F;&#x2F; since the purpose of this block is to read applicationConfigFiles
                &#x2F;&#x2F; from &#x2F;application.json, and the rest is part of this.createMultipartYCB
                ycb = this.readConfigYCB(rootAppJSON, {
                    runtime: &#x27;server&#x27;
                });
                &#x2F;&#x2F; adding the master application.json as the top level
                paths.push(rootAppJSON);
                &#x2F;&#x2F; optional applicationConfigFiles to mix in more configs
                relativePaths = ycb.applicationConfigFiles || [];
                for (i = 0; i &lt; relativePaths.length; i += 1) {
                    paths.push(libpath.resolve(this.appRoot, relativePaths[i]));
                }
            }

            &#x2F;&#x2F; Note: it doesn&#x27;t matter if we try to reach the same file multiple
            &#x2F;&#x2F; times (application.json) because readConfigSimple will cache it anyway
            ycb = this.createMultipartYCB(paths);
            if (!ycb) {
                throw new Error(&quot;failed to create a YCB config from the following files:\n  &quot; + paths.join(&quot;\n  &quot;));
            }
            return ycb;
        }

    });
    Y.namespace(&#x27;mojito.addons.rs&#x27;);
    Y.mojito.addons.rs.config = RSAddonConfig;

}, &#x27;0.0.1&#x27;, { requires: [&#x27;plugin&#x27;, &#x27;oop&#x27;, &#x27;mojito-util&#x27;]});

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="..&#x2F;assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="..&#x2F;assets/js/yui-prettify.js"></script>
<script src="..&#x2F;assets/../api.js"></script>
<script src="..&#x2F;assets/js/api-filter.js"></script>
<script src="..&#x2F;assets/js/api-list.js"></script>
<script src="..&#x2F;assets/js/api-search.js"></script>
<script src="..&#x2F;assets/js/apidocs.js"></script>
</body>
</html>

<!-- SpaceID=0 robot -->

<!-- VER-3.0.246810 -->
<!-- p1.ydn.bf1.yahoo.com uncompressed/chunked Fri Oct  4 11:13:26 PDT 2013 -->
