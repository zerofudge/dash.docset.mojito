<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>node_modules&#x2F;mojito&#x2F;lib&#x2F;app&#x2F;autoload&#x2F;perf.server.js - Mojito API</title>
    <link rel="stylesheet" href="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;3.8.0pr2&#x2F;build&#x2F;cssgrids&#x2F;cssgrids-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="..&#x2F;assets/favicon.png">
    <script src="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;combo?3.8.0pr2&#x2F;build&#x2F;yui&#x2F;yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="http:&#x2F;&#x2F;developer.yahoo.com&#x2F;cocktails&#x2F;mojito&#x2F;api&#x2F;assets&#x2F;img&#x2F;mojito-logo-white-bkg.png" title="Mojito API"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.7.5</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="..&#x2F;classes/ActionContext.html">ActionContext</a></li>
            
                <li><a href="..&#x2F;classes/Analytics.common.html">Analytics.common</a></li>
            
                <li><a href="..&#x2F;classes/Assets.common.html">Assets.common</a></li>
            
                <li><a href="..&#x2F;classes/Composite.common.html">Composite.common</a></li>
            
                <li><a href="..&#x2F;classes/Config.common.html">Config.common</a></li>
            
                <li><a href="..&#x2F;classes/Cookie.client.html">Cookie.client</a></li>
            
                <li><a href="..&#x2F;classes/Cookie.server.html">Cookie.server</a></li>
            
                <li><a href="..&#x2F;classes/Data.common.data.html">Data.common.data</a></li>
            
                <li><a href="..&#x2F;classes/Data.common.pageData.html">Data.common.pageData</a></li>
            
                <li><a href="..&#x2F;classes/Deploy.server.html">Deploy.server</a></li>
            
                <li><a href="..&#x2F;classes/Helpers.common.html">Helpers.common</a></li>
            
                <li><a href="..&#x2F;classes/Http.server.html">Http.server</a></li>
            
                <li><a href="..&#x2F;classes/Intl.common.html">Intl.common</a></li>
            
                <li><a href="..&#x2F;classes/Meta.common.html">Meta.common</a></li>
            
                <li><a href="..&#x2F;classes/Model.Vanilla.html">Model.Vanilla</a></li>
            
                <li><a href="..&#x2F;classes/Models.common.html">Models.common</a></li>
            
                <li><a href="..&#x2F;classes/MojitoDispatcher.html">MojitoDispatcher</a></li>
            
                <li><a href="..&#x2F;classes/MojitoPerf.html">MojitoPerf</a></li>
            
                <li><a href="..&#x2F;classes/MojitoRouter.html">MojitoRouter</a></li>
            
                <li><a href="..&#x2F;classes/MojitProxy.html">MojitProxy</a></li>
            
                <li><a href="..&#x2F;classes/OutputBuffer.html">OutputBuffer</a></li>
            
                <li><a href="..&#x2F;classes/OutputHandler.html">OutputHandler</a></li>
            
                <li><a href="..&#x2F;classes/Params.common.html">Params.common</a></li>
            
                <li><a href="..&#x2F;classes/Partial.common.html">Partial.common</a></li>
            
                <li><a href="..&#x2F;classes/ResourceStore.server.html">ResourceStore.server</a></li>
            
                <li><a href="..&#x2F;classes/RSAddonConfig.html">RSAddonConfig</a></li>
            
                <li><a href="..&#x2F;classes/RSAddonDispatchHelper.html">RSAddonDispatchHelper</a></li>
            
                <li><a href="..&#x2F;classes/RSAddonMime.html">RSAddonMime</a></li>
            
                <li><a href="..&#x2F;classes/RSAddonSelector.html">RSAddonSelector</a></li>
            
                <li><a href="..&#x2F;classes/RSAddonUrl.html">RSAddonUrl</a></li>
            
                <li><a href="..&#x2F;classes/RSAddonYUI.html">RSAddonYUI</a></li>
            
                <li><a href="..&#x2F;classes/Url.common.html">Url.common</a></li>
            
                <li><a href="..&#x2F;classes/Y.mojito.Client.html">Y.mojito.Client</a></li>
            
                <li><a href="..&#x2F;classes/Y.mojito.lib.REST.html">Y.mojito.lib.REST</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="..&#x2F;modules/ActionContext.html">ActionContext</a></li>
            
                <li><a href="..&#x2F;modules/ActionContextAddon.html">ActionContextAddon</a></li>
            
                <li><a href="..&#x2F;modules/app.html">app</a></li>
            
                <li><a href="..&#x2F;modules/CommonLibs.html">CommonLibs</a></li>
            
                <li><a href="..&#x2F;modules/Data.common.html">Data.common</a></li>
            
                <li><a href="..&#x2F;modules/model-vanilla.html">model-vanilla</a></li>
            
                <li><a href="..&#x2F;modules/mojito-perf.html">mojito-perf</a></li>
            
                <li><a href="..&#x2F;modules/MojitoClient.html">MojitoClient</a></li>
            
                <li><a href="..&#x2F;modules/MojitoHooks.html">MojitoHooks</a></li>
            
                <li><a href="..&#x2F;modules/OutputBuffer.html">OutputBuffer</a></li>
            
                <li><a href="..&#x2F;modules/ResourceStore.html">ResourceStore</a></li>
            
                <li><a href="..&#x2F;modules/ResourceStoreAddon.html">ResourceStoreAddon</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: node_modules&#x2F;mojito&#x2F;lib&#x2F;app&#x2F;autoload&#x2F;perf.server.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x2F;*
 * Copyright (c) 2011-2013, Yahoo! Inc.  All rights reserved.
 * Copyrights licensed under the New BSD License.
 * See the accompanying LICENSE file for terms.
 *&#x2F;
&#x2F;*jslint anon:true, node: true, nomen:true*&#x2F;
&#x2F;*global YUI,require*&#x2F;
YUI.add(&#x27;mojito-perf&#x27;, function (Y, NAME) {

    &#x27;use strict&#x27;;

    &#x2F;**
     * @module mojito-perf
     * @class MojitoPerf
     * @static
     *&#x2F;

    var libfs = require(&#x27;fs&#x27;),

        buffer = {},
        config = Y.config.perf,

        requestId  = 0,
        colorRed   = &#x27;\u001b[31m&#x27;,
        colorReset = &#x27;\u001b[0m&#x27;,

        getgo,
        microtime;


    try {
        microtime = require(&#x27;microtime&#x27;);
    } catch (e) {
        Y.log(&#x27;microtime not found. Recorded times will not have&#x27; +
            &#x27; microsecond accuracy&#x27;, &#x27;warn&#x27;, NAME);
    }


    &#x2F;&#x2F;internal. write perf info into a file
    function writeLog(filename, logs) {
        var outstream,
            i;

        try {
            outstream = libfs.createWriteStream(filename.replace(&#x27;{req}&#x27;, requestId), {
                flags: &#x27;a&#x27; &#x2F;&#x2F; append
            });
            for (i = 0; i &lt; logs.length; i += 1) {
                outstream.write(logs[i].join(&#x27;|&#x27;) + &quot;\n&quot;);
            }
            outstream.end();
            outstream = null;
        } catch (err) {
            Y.log(&#x27;Error trying to dump perf metrics in file: &#x27; +
                filename + &#x27; Error:&#x27; + err, &#x27;error&#x27;, NAME);
        }
    }


    &#x2F;&#x2F;internal. print perf info in the logs
    function print(group, key) {
        var o = buffer[group][key],
            type = (o.ms ? &#x27;TIMELINE&#x27; : &#x27;MARK&#x27;),
            &#x2F;&#x2F; if we already have milliseconds, good
            &#x2F;&#x2F; if not, we can compute it based on request init
            time = o.time,
            offset = o.time - getgo,
            duration = o.ms || &#x27;&#x27;,
            desc = o.msg || &#x27;no description&#x27;,
            label = o.label,
            id = o.id;

        if ((config.mark &amp;&amp; !o.ms) || (config.timeline &amp;&amp; o.ms)) {

            Y.log(group + &#x27;:&#x27; + key + &#x27; &#x27; + type + colorReset +
                &#x27; offset=&#x27; + colorRed + offset + colorReset +
                (o.ms ? &#x27; duration=&#x27; + colorRed + duration + colorReset : &#x27;&#x27;) +
                &#x27; (&#x27; + desc + &#x27;)&#x27;,
                &#x27;mojito&#x27;, NAME);

            return [type, requestId, time, duration, group, label, id, desc];

        }

    }


    &#x2F;&#x2F;internal. abstracts where timestamps come from
    function timestamp() {
        return microtime ? microtime.now() : new Date().getTime();
    }


    &#x2F;**
     * Produces an ID to identify the timeline or mark based on a
     * command object.
     *
     * @method idFromCommand
     * @private
     * @param {object} command Object that represent the command to invoke.
     * @return {string} ID that represents the command.
     **&#x2F;
    function idFromCommand(command) {
        var str;
        if (command &amp;&amp; command.instance) {
            if (command.instance.id) {
                str = command.instance.id;
            } else if (command.instance.base) {
                str = &#x27;+&#x27; + command.instance.base;
            } else {
                str = &#x27;@&#x27; + command.instance.type;
            }
            str += &#x27;.&#x27; + (command.action || command.instance.action || &#x27;???&#x27;);
        }
        return str;
    }


    &#x2F;**
     * Sets a mark in the request timeline. All marks will be flushed
     * after the end. This is useful to measure when a particular process
     * start or end with respect to the request timeline.
     *
     * @method mark
     * @param {string} group Event group.
     * @param {string} label Event identifier. Will be combined with group.
     * @param {string} msg Description of the mark.
     * @param {string|object} id Unique identifier of the mark, usually
     *      the requestId or a command object.
     * @return {Object} The mark entry.
     **&#x2F;
    function mark(group, label, msg, id) {
        var s,
            key = label;

        if (!group || !label) {
            return;
        }

        if (id) {
            &#x2F;&#x2F; we might also accept a command object
            id = Y.Lang.isObject(id) ? idFromCommand(id) : id;
            key += &#x27;[&#x27; + id + &#x27;]&#x27;;
        }

        if (!buffer[group]) {
            buffer[group] = {};
        }

        if (!msg) {
            msg = &#x27;&#x27;;
        }

        if (buffer[group][key]) {
            Y.log(&#x27;Perf metric collision for group=&#x27; + group +
                &#x27; label=&#x27; + label + &#x27; id=&#x27; + id +
                &#x27;. Measure one thing at a time.&#x27;, &#x27;warn&#x27;, NAME);
            key += Y.guid();
        }

        s = buffer[group][key] = {};
        s.msg = msg;
        s.label = label;
        s.id = id;
        s.time = timestamp();
        return s;
    }


    &#x2F;**
     * Starts a timeline metric, providing a way to call it done
     * at some point in the future. This is useful to measure the
     * time to execute a process in mojito.
     *
     * @method timeline
     * @param {string} group Event group.
     * @param {string} label Event identifier. Will be combined with group.
     * @param {string} msg Description of the mark.
     * @param {string} id Unique identifier of the mark, usually
     *      the requestId or the yuid().
     * @return {object} represents the timeline object that has a method
     *      called &quot;done&quot; that can be invoked when the process finish.
     **&#x2F;
    function timeline(group, label, msg, id) {
        var m = mark(group, label, msg, id);
        return {
            done: function () {
                m.ms = timestamp() - m.time;
            }
        };
    }


    &#x2F;**
     * Dumps all marks and timeline entries into the console.
     * This method is meant to be called automatically when
     * a request ends. You can target specific metrics by using
     * the configuration:
     *
     * &quot;perf&quot;: {
     *    &quot;include&quot;: {
     *        &quot;mojito-action-context&quot;: true
     *    }
     * }
     *
     * Or just exclude some of them by doing:
     *
     * &quot;perf&quot;: {
     *    &quot;exclude&quot;: {
     *        &quot;mojito-action-context&quot;: true
     *    }
     * }
     *
     *
     * @method dump
     * @private
     * @return {array} collection of perf logs. Each item will expose:
     *     {type, requestId, time, duration, group, label, id, desc}
     **&#x2F;
    function dump() {

        var group,
            key,
            entry,
            logs = [];

        for (group in buffer) {
            if ((buffer.hasOwnProperty(group)) &amp;&amp;
                    (!config.exclude || !config.exclude[group]) &amp;&amp;
                    (!config.include || config.include[group])) {
                for (key in buffer[group]) {
                    if (buffer[group].hasOwnProperty(key)) {
                        entry = print(group, key);
                        if (entry) {
                            logs.push(entry);
                        }
                    }
                }
            }
        }
        buffer = {};
        &#x2F;&#x2F; dumping to disk
        if (config.logFile) {
            Y.log(&#x27;Dumping performance metrics into disk: &#x27; +
                config.logFile, &#x27;mojito&#x27;, NAME);
            writeLog(config.logFile, logs);
        }

        return logs;
    }


    &#x2F;**
     * Instruments requests that will be processed by mojito
     * core, providing a valid timeline for that request, and
     * allowing to instrument some other relative processes,
     * and grouping them per request to facilitate analysis.
     * This method is responsible for calling &quot;dump&quot;.
     *
     * @method instrumentMojitoRequest
     * @param {object} req the request object from express.
     * @param {object} res the response object from express.
     **&#x2F;
    function instrumentMojitoRequest(req, res) {
        var id = (requestId += 1),
            perf,
            end = res.end;

        getgo = timestamp();
        if (Y.Object.keys(buffer).length &gt; 0) {
            Y.log(&#x27;Multiple requests at the same time. This can &#x27; +
                    &#x27;mess with the perf analysis. Curl is your best &#x27; +
                    &#x27;friend, use it.&#x27;, &#x27;warn&#x27;, NAME);
        }

        perf = timeline(&#x27;mojito&#x27;, &#x27;request&#x27;, &#x27;the whole request&#x27;, id);

        &#x2F;&#x2F; hooking into the res.end called from output-handler.server.js
        &#x2F;&#x2F; to be able to flush perf metrics only for mojito requests.
        &#x2F;&#x2F; static requests and other type of requests will be ignored.
        res.end = function () {
            if (perf) {
                end.apply(res, arguments);
                Y.log(&#x27;Flushing perf metrics&#x27;, &#x27;mojito&#x27;, NAME);
                perf.done();
                dump();
                &#x2F;&#x2F; some cleanup
                perf = null;
                end = null;
                req = null;
                res = null;
            }
        };
    }

    if (config) {
        Y.namespace(&#x27;mojito.perf&#x27;);
        Y.mojito.perf.idFromCommand = idFromCommand;
        Y.mojito.perf.instrumentMojitoRequest = instrumentMojitoRequest;
        Y.mojito.perf.dump = dump;

        &#x2F;&#x2F; overriding the default definitions if needed
        if (config.timeline) {
            Y.mojito.perf.timeline = timeline;
        }
        if (config.mark) {
            Y.mojito.perf.mark = mark;
        }
    } else {
        config = {};
    }

    &#x2F;&#x2F; Hook profiles in
    Y.mojito.hooks.registerHook(NAME, &#x27;adapterBuffer&#x27;, function(w, adapter) {
        if (w === &#x27;start&#x27;) {
            this.ab_perf = Y.mojito.perf.timeline(&#x27;mojito-composite-addon&#x27;, &#x27;child&#x27;, &#x27;the whole child&#x27;, adapter.id);
        } else {
            this.ab_perf.done();
        }
    });
    Y.mojito.hooks.registerHook(NAME, &#x27;addon&#x27;, function(w, addOn, cfg) {
        if (w === &#x27;start&#x27;) {
            this.ad_perf = Y.mojito.perf.timeline(&#x27;mojito-composite-addon&#x27;, &#x27;execute&#x27;, Y.Object.keys(cfg.children).join(&#x27;,&#x27;), addOn.ac.command);
        } else {
            this.ad_perf.done();
        }
    });
    Y.mojito.hooks.registerHook(NAME, &#x27;hb&#x27;, function(w, tmpl) {
        if (w === &#x27;start&#x27;) {
            this.hb_perf = Y.mojito.perf.timeline(&#x27;mojito&#x27;, &#x27;hb:render&#x27;, &#x27;time to render a template&#x27;, tmpl);
        } else {
            this.hb_perf.done();
        }
    });
    Y.mojito.hooks.registerHook(NAME, &#x27;attachActionContext&#x27;, function(w, command) {
        if (w === &#x27;start&#x27;) {
            this.acc_perf = Y.mojito.perf.timeline(&#x27;mojito&#x27;, &#x27;ac:addons&#x27;, &#x27;attaching addons to AC object&#x27;, command);
        } else {
            this.acc_perf.done();
        }
    });
    Y.mojito.hooks.registerHook(NAME, &#x27;actionContext&#x27;, function(w, ac, opts) {
        if (w === &#x27;start&#x27;) {
            this.ac_perf = Y.mojito.perf.timeline(&#x27;mojito&#x27;, &#x27;ac:init&#x27;, &#x27;set up AC object&#x27;, opts.command);
        } else if (w === &#x27;end1&#x27;) {
            this.ac_perf.done();
            Y.mojito.perf.mark(&#x27;mojito&#x27;, &#x27;action:start&#x27;, &#x27;before the action&#x27;, opts.command);
            this.ac_perf = Y.mojito.perf.timeline(&#x27;mojito&#x27;, &#x27;action:call&#x27;, &#x27;the initial syncronous part of the action&#x27;, opts.command);
        } else {
            this.ac_perf.done();
        }
    });
    Y.mojito.hooks.registerHook(NAME, &#x27;actionContextDone&#x27;, function(w, ac) {
        if (w === &#x27;start&#x27;) {
            this.acd_perf = Y.mojito.perf.timeline(&#x27;mojito&#x27;, &#x27;ac.done&#x27;, &#x27;time to execute ac.done process&#x27;, ac.command);
        } else if (w === &#x27;end1&#x27;) {
            this.acd_perf.done();
        } else {
            this.acd_perf.done();
            Y.mojito.perf.mark(&#x27;mojito&#x27;, &#x27;action:stop&#x27;, &#x27;after the action&#x27;, ac.command);
        }
    });
    Y.mojito.hooks.registerHook(NAME, &#x27;dispatchCreateAction&#x27;, function(w, command) {
        if (w === &#x27;start&#x27;) {
            this.dac_perf = Y.mojito.perf.timeline(&#x27;mojito&#x27;, &#x27;ac:ctor&#x27;, &#x27;create ControllerContext&#x27;, command);
        } else {
            this.dac_perf.done();
        }
    });
    Y.mojito.hooks.registerHook(NAME, &#x27;dispatch&#x27;, function(w, command) {
        if (w === &#x27;start&#x27;) {
            this.dis_perf = Y.mojito.perf.timeline(&#x27;mojito&#x27;, &#x27;dispatch:expandInstance&#x27;, &#x27;gather details about mojit&#x27;, command);
        } else {
            this.dis_perf.done();
        }
    });
    Y.mojito.hooks.registerHook(NAME, &#x27;AppDispatch&#x27;, function(req, res) {
        &#x2F;&#x2F; if perf metrics are on, we should hook into
        &#x2F;&#x2F; the mojito request to flush metrics when
        &#x2F;&#x2F; the connection is closed.
        if (Y.mojito.perf.instrumentMojitoRequest) {
            Y.mojito.perf.instrumentMojitoRequest(req, res);
        }
    });

}, &#x27;0.1.0&#x27;, {requires: [
    &#x27;mojito&#x27;,
    &#x27;mojito-hooks&#x27;
]});

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="..&#x2F;assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="..&#x2F;assets/js/yui-prettify.js"></script>
<script src="..&#x2F;assets/../api.js"></script>
<script src="..&#x2F;assets/js/api-filter.js"></script>
<script src="..&#x2F;assets/js/api-list.js"></script>
<script src="..&#x2F;assets/js/api-search.js"></script>
<script src="..&#x2F;assets/js/apidocs.js"></script>
</body>
</html>

<!-- SpaceID=0 robot -->

<!-- VER-3.0.246810 -->
<!-- p1.ydn.bf1.yahoo.com uncompressed/chunked Fri Oct  4 11:13:19 PDT 2013 -->
